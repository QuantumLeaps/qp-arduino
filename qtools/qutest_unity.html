<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>QTools: Basic Unity Example</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="ql.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
  <a title="Quantum Leaps: Modern Embedded Software" href="https://www.state-machine.com">
    <img id="logo" src="img/logo_ql.png" alt="Quantum Leaps">
  </a>
  <span id="projectname">QTools</span>
  <span id="projectnumber">6.9.3</span>
           <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.svg"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)"
               onblur="searchBox.OnSearchFieldFocus(false)"
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;"
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('qutest_unity.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0"
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Basic Unity Example </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#qutest_unity-cut">Code Under Test (CUT)</a></li>
<li class="level1"><a href="#qutest_unity-run0">Running the Test with Unity</a></li>
<li class="level1"><a href="#qutest_unity-run">Running the Test with QUTest</a></li>
<li class="level1"><a href="#qutest_unity-fixture">Test Fixture</a></li>
<li class="level1"><a href="#qutest_unity-script">Test Script</a></li>
<li class="level1"><a href="#qutest_unity-embed">Running the Test on Embedded Targets</a></li>
</ul>
</div>
<div class="textblock"><p>This example is based on the simple <code>example_1</code> that ships with the <a href="http://www.throwtheswitch.org/unity" target="_blank" class="extern"><b>Unity unit testing framework</b></a>. This simplest example of Unity has nothing to do with the QP frameworks. The purpose is to illustrate that QUTest&trade; can be used with generic C code and to compare QUTest&trade; with Unity. </p>
<dl class="section remark"><dt>Remarks</dt><dd>This simple example runs QUTest tests on the host (Windows, Linux, or MacOS) for both Unity and QUTest. The QUTest version also runs on embedded boards (TivaC LaunchPad from Texas Instruments and EFM32 Pearl-Gecko board from Silicon Labs). The instructions for building and running the code on the embedded boards are located at the end of this lesson. <br  />
<div class="image">
<img src="platforms.png" alt=""/>
</div>
</dd></dl>
<h1><a class="anchor" id="qutest_unity-cut"></a>
Code Under Test (CUT)</h1>
<dl class="section note"><dt>Note</dt><dd>Because it uses pure C code, the Basic Unity example is only available in the <a href="https://www.state-machine.com/qpc"><b>QP/C framework</b></a> (and is <b>not</b> available in the <a href="https://www.state-machine.com/qpcpp">QP/C++ framework</a>).</dd></dl>
<p>The CUT in this example is the file <span class="img file_c"><code>ProductionCode.c</code></span> located in the directory <span class="img folder"><code>C:\qp\qpc\examples\qutest\unity_basic\src</code></span>. The CUT contains just two functions with some fairly obvious errors. The purpose of the example is to find these errors by unit-testing this "production code":</p>
<p><a class="anchor" id="qutest_tut_basic-cut"></a></p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160; </div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="preprocessor">#include &quot;ProductionCode.h&quot;</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160; </div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="keywordtype">int</span> Counter = 0;</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="keywordtype">int</span> NumbersToFind[9] = { 0, 34, 55, 66, 32, 11, 1, 77, 888 }; <span class="comment">/* some obnoxious array to search that is 1-based indexing instead of 0. */</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160; </div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">/* This function is supposed to search through NumbersToFind and find a particular number.</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment"> * If it finds it, the index is returned.  Otherwise 0 is returned which sorta makes sense since</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment"> * NumbersToFind is indexed from 1.  Unfortunately it&#39;s broken</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment"> * (and should therefore be caught by our tests) */</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="keywordtype">int</span> FindFunction_WhichIsBroken(<span class="keywordtype">int</span> NumberToFind)</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;{</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;    <span class="keywordtype">int</span> i = 0;</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;    <span class="keywordflow">while</span> (i &lt; 8) <span class="comment">/* Notice I should have been in braces */</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;        i++;</div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;        <span class="keywordflow">if</span> (NumbersToFind[i] == NumberToFind) <span class="comment">/* Yikes!  I&#39;m getting run after the loop finishes instead of during it! */</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;            <span class="keywordflow">return</span> i;</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;}</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160; </div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="keywordtype">int</span> FunctionWhichReturnsLocalVariable(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;{</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;    <span class="keywordflow">return</span> Counter;</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;}</div>
</div><!-- fragment --><h1><a class="anchor" id="qutest_unity-run0"></a>
Running the Test with Unity</h1>
<p>The complete code for the basic Unity example is provided in the QP/C framework, directory <span class="img folder"><code>C:\qp\qpc\examples\qutest\unity_basic\test_unity</code></span>. To run the basic Unity test (on Windows), open a command-prompt and type: </p><pre class="fragment">cd C:\qp\qpc\examples\qutest\unity_basic\test_unity
make
</pre><dl class="section note"><dt>Note</dt><dd>The provided <code>Makefile</code> will also work on Linux and MacOS. The only difference from Winows is that you open a terminal window and change directory to <span class="img folder"><code>~/qp/qpc/examples/qutest/unity_basic/test_unity</code></span>.</dd></dl>
<p>This will build the <a class="el" href="qutest_unity.html#qutest_unity-fixture">test fixture</a> as a host executable and then it will run it. The screen shot below shows the output produced from the make command.</p>
<div class="image">
<img src="unity_basic_unity.png" alt=""/>
<div class="caption">
Unity example_1 test build and run with Unity</div></div>
<dl class="section remark"><dt>Remarks</dt><dd>As you can see, two out of five Unity tests <b>fail</b>. This is intentional, because the CUT is faulty.</dd></dl>
<h1><a class="anchor" id="qutest_unity-run"></a>
Running the Test with QUTest</h1>
<p>The complete code for the basic Unity example is provided in the QP/C framework, directory <span class="img folder"><code>C:\qp\qpc\examples\qutest\unity_basic\test</code></span>. To run the basic test (on Windows), open a command prompt and type:</p>
<pre class="fragment">qspy
</pre><p>This will start the <a class="el" href="qspy.html">QSPY host utility</a> with the TCP/IP connection to the Target.</p>
<p>Next, open a <b>second</b> command prompt window and type:</p>
<pre class="fragment">cd C:\qp\qpc\examples\qutest\unity_basic\test
make
</pre><dl class="section note"><dt>Note</dt><dd>The provided <code>Makefile</code> will also work on Linux and MacOS. The only difference from Windows is that you open a terminal window and change directory to <span class="img folder"><code>~/qp/qpc/examples/qutest/unity_basic/test</code></span>.</dd></dl>
<p>This will build the <a class="el" href="qutest_unity.html#qutest_unity-fixture">test fixture</a> as a host executable and then it will run the <a class="el" href="qutest_unity.html#qutest_unity-script">test script</a> (in Python). The screen shot below shows the output produced in these two command-prompt windows.</p>
<div class="image">
<img src="unity_basic_qutest.png" alt=""/>
<div class="caption">
Unity example_1 test build and run with QUTest (left) and QSPY output (right).</div></div>
<dl class="section remark"><dt>Remarks</dt><dd>As you can see, two out of five QUTest tests <b>fail</b>. These are the same tests (adapted for QUTest) that failed during testing with Unity above.</dd></dl>
<h1><a class="anchor" id="qutest_unity-fixture"></a>
Test Fixture</h1>
<p>The job of a <a class="el" href="qutest_fixture.html">test fixture</a> is to exercise the <a href="https://www.state-machine.com/glossary#CUT" class="extern"><b>CUT</b></a> (<span class="img file_c"><code>ProductionCode.c</code></span> in this case) and report the results back to the <a class="el" href="qspy.html">QSPY host application</a>. Note that a <em>test fixture</em> in QUTest&trade; is <b>not</b> supposed to perform any checks whether the CUT operates "correctly". Instead, your <em>test fixture</em> should only provide facilities to thoroughly exercise the <b>CUT</b> remotely from the <a class="el" href="qutest_unity.html#qutest_unity-script">test script</a>(s). A properly written test fixture can be typically used for many tests (implemented in multiple test scripts).</p>
<dl class="section remark"><dt>Remarks</dt><dd>Coming up with a "good" <em>test fixture</em> requires some practice, but when you study the examples in this Tutorial, you will see some instances of flexible <em>test fixtures</em> that allow you to to run a wide variety of tests on them.</dd></dl>
<p>The following listing shows the complete QUTest <em>test fixture</em> for the basic tests (file <span class="img file_c"><code>test_ProductionCode.c</code></span> in the directory <span class="img folder"><code>C:\qp\qpc\examples\qutest\unity_basic\test</code></span>). The explanation section following the listing clarifies the interesting lines of code (lines starting with <code>[xx]</code> labels).</p>
<div class="fragment"><div class="line"> [1] #<a class="code" href="namespacequtest__dsl.html#a1e5777a9cd236612645088169cc07e9d">include</a> <span class="stringliteral">&quot;qpc.h&quot;</span>  <span class="comment">/* QUTest interface */</span></div>
<div class="line"> [2] #<a class="code" href="namespacequtest__dsl.html#a1e5777a9cd236612645088169cc07e9d">include</a> <span class="stringliteral">&quot;ProductionCode.h&quot;</span> <span class="comment">/* CUT interface */</span></div>
<div class="line"> </div>
<div class="line"> [3] Q_DEFINE_THIS_FILE</div>
<div class="line"> </div>
<div class="line">     <span class="comment">/*--------------------------------------------------------------------------*/</span></div>
<div class="line">     <span class="comment">// sometimes you may want to get at local data in a module.</span></div>
<div class="line">     <span class="comment">// for example: If you plan to pass by reference, this could be useful</span></div>
<div class="line">     <span class="comment">// however, it should often be avoided</span></div>
<div class="line"> [4] <span class="keyword">extern</span> <span class="keywordtype">int</span> Counter;</div>
<div class="line"> </div>
<div class="line">     <span class="comment">/*--------------------------------------------------------------------------*/</span></div>
<div class="line"> [5] <span class="keywordtype">int</span> <a class="code" href="namespaceqview.html#a0ac274e7bffb2a1b29949100cd43ca35">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[]) {</div>
<div class="line"> </div>
<div class="line"> [6]     QF_init();  <span class="comment">/* initialize the framework */</span></div>
<div class="line"> </div>
<div class="line">         <span class="comment">/* initialize the QS software tracing */</span></div>
<div class="line"> [7]     Q_ALLEGE(<a class="code" href="qs__copy_8h.html#af22371611fe57862a37eb785debb7921">QS_INIT</a>(argc &gt; 1 ? argv[1] : (<span class="keywordtype">void</span> *)0));</div>
<div class="line"> </div>
<div class="line">         <span class="comment">/* dictionaries... */</span></div>
<div class="line"> [8]     <a class="code" href="qs__copy_8h.html#a3b1ab21c174f2bec448edec8865a8529">QS_FUN_DICTIONARY</a>(&amp;FindFunction_WhichIsBroken);</div>
<div class="line"> [9]     <a class="code" href="qs__copy_8h.html#a3b1ab21c174f2bec448edec8865a8529">QS_FUN_DICTIONARY</a>(&amp;FunctionWhichReturnsLocalVariable);</div>
<div class="line">[10]     <a class="code" href="qs__copy_8h.html#a034206ff7f20a4e6426a5f554434643b">QS_OBJ_DICTIONARY</a>(&amp;Counter);</div>
<div class="line"> </div>
<div class="line">         <span class="comment">/* filter setup... */</span></div>
<div class="line">[11]     QS_FILTER_ON(<a class="code" href="qs__copy_8h.html#a4811826c90b13a0b7137e0443e82d41cae7b17c3ad4c237e9e89693fea1690513">QS_ALL_RECORDS</a>);</div>
<div class="line"> </div>
<div class="line">[12]     <span class="keywordflow">return</span> QF_run(); <span class="comment">/* run the tests */</span></div>
<div class="line">     }</div>
<div class="line"> </div>
<div class="line">     <span class="comment">/*--------------------------------------------------------------------------*/</span></div>
<div class="line">[13] <span class="keywordtype">void</span> <a class="code" href="qs__copy_8h.html#a3d316077c13f8033c1a391590937e696">QS_onTestSetup</a>(<span class="keywordtype">void</span>) {</div>
<div class="line">     }</div>
<div class="line">     <span class="comment">/*..........................................................................*/</span></div>
<div class="line">[14] <span class="keywordtype">void</span> <a class="code" href="qs__copy_8h.html#abefe60a3ba6b11d5406bba4708a48f2d">QS_onTestTeardown</a>(<span class="keywordtype">void</span>) {</div>
<div class="line">     }</div>
<div class="line"> </div>
<div class="line">     <span class="comment">/*..........................................................................*/</span></div>
<div class="line">[15] <span class="keywordtype">void</span> <a class="code" href="qs__copy_8h.html#af824d5b11fdd09d1bb4775c9b32e4530">QS_onCommand</a>(uint8_t cmdId,</div>
<div class="line">                       uint32_t param1, uint32_t param2, uint32_t param3)</div>
<div class="line">     {</div>
<div class="line">         <span class="keywordflow">switch</span> (cmdId) {</div>
<div class="line">             <span class="keywordflow">case</span> 0: { <span class="comment">/* call the CUT: FindFunction_WhichIsBroken */</span></div>
<div class="line">[16]             <span class="keywordtype">int</span> ret = FindFunction_WhichIsBroken((<span class="keywordtype">int</span>)param1);</div>
<div class="line">[17]             QS_BEGIN(<a class="code" href="qs__copy_8h.html#acdb495c1e5524b5d95aaff82c47f6db5a48cec974671d01f280b2b1a33225d176">QS_USER</a> + cmdId, (<span class="keywordtype">void</span> *)0) <span class="comment">/* user-specific record */</span></div>
<div class="line">[18]                 <a class="code" href="qs__copy_8h.html#a9342913835bccef5ded5a59d2712101a">QS_FUN</a>(&amp;FindFunction_WhichIsBroken); <span class="comment">/* function called */</span></div>
<div class="line">[19]                 <a class="code" href="qs__copy_8h.html#aa3e19e4d0d7a2075951ac5c3fe389936">QS_I32</a>(0, (int32_t)ret); <span class="comment">/* returned value */</span></div>
<div class="line">[20]                 <a class="code" href="qs__copy_8h.html#aa56a51195cc2819fb2612e3c24723bae">QS_I16</a>(0, (int16_t)param1); <span class="comment">/* parameter */</span></div>
<div class="line">[21]             <a class="code" href="qs__copy_8h.html#a2ed1002d3dda6d95f9f64c59b8453c71">QS_END</a>()</div>
<div class="line">                 break;</div>
<div class="line">             }</div>
<div class="line">             case 1: { <span class="comment">/* call the CUT: FunctionWhichReturnsLocalVariable */</span></div>
<div class="line">[22]             <span class="keywordtype">int</span> ret = FunctionWhichReturnsLocalVariable();</div>
<div class="line">[23]             QS_BEGIN(<a class="code" href="qs__copy_8h.html#acdb495c1e5524b5d95aaff82c47f6db5a48cec974671d01f280b2b1a33225d176">QS_USER</a> + cmdId, (<span class="keywordtype">void</span> *)0) <span class="comment">/* user-specific record */</span></div>
<div class="line">[24]                 <a class="code" href="qs__copy_8h.html#a9342913835bccef5ded5a59d2712101a">QS_FUN</a>(&amp;FunctionWhichReturnsLocalVariable); <span class="comment">/* function called */</span></div>
<div class="line">[25]                 QS_U32_HEX(0, (uint32_t)ret); <span class="comment">/* returned value */</span></div>
<div class="line">[26]             <a class="code" href="qs__copy_8h.html#a2ed1002d3dda6d95f9f64c59b8453c71">QS_END</a>()</div>
<div class="line">                 break;</div>
<div class="line">             }</div>
<div class="line">             default:</div>
<div class="line">                 break;</div>
<div class="line">         }</div>
<div class="line"> </div>
<div class="line">         <span class="comment">/* unused parametrers... */</span></div>
<div class="line">         <span class="comment">//(void)param1;</span></div>
<div class="line">         (<span class="keywordtype">void</span>)param2;</div>
<div class="line">         (<span class="keywordtype">void</span>)param3;</div>
<div class="line">     }</div>
<div class="line">     <span class="comment">/*..........................................................................*/</span></div>
<div class="line">     <span class="comment">/* host callback function to &quot;massage&quot; the event, if necessary */</span></div>
<div class="line">[27] <span class="keywordtype">void</span> <a class="code" href="qs__copy_8h.html#ad3f890b82210f9d63348d9764bdc1073">QS_onTestEvt</a>(QEvt *e) {</div>
<div class="line">         (void)e;</div>
<div class="line"><span class="preprocessor">     #ifdef Q_HOST  </span><span class="comment">/* is this test compiled for a desktop Host computer? */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">     #else </span><span class="comment">/* this test is compiled for an embedded Target system */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">     #endif</span></div>
<div class="line">     }</div>
<div class="line">     <span class="comment">/*..........................................................................*/</span></div>
<div class="line">[28] <span class="keywordtype">void</span> <a class="code" href="qs__copy_8h.html#a14579f8a23d950a5f2393fa3f9b0e145">QS_onTestPost</a>(<span class="keywordtype">void</span> <span class="keyword">const</span> *sender, QActive *recipient,</div>
<div class="line">                        QEvt <span class="keyword">const</span> *e, <span class="keywordtype">bool</span> status)</div>
<div class="line">     {</div>
<div class="line">         (void)sender;</div>
<div class="line">         (void)recipient;</div>
<div class="line">         (void)e;</div>
<div class="line">         (void)status;</div>
<div class="line">     }</div>
<div class="ttc" id="anamespacequtest__dsl_html_a1e5777a9cd236612645088169cc07e9d"><div class="ttname"><a href="namespacequtest__dsl.html#a1e5777a9cd236612645088169cc07e9d">qutest_dsl.include</a></div><div class="ttdeci">def include(fname)</div><div class="ttdoc">include python code in a test script</div><div class="ttdef"><b>Definition:</b> <a href="qutest__dsl_8py_source.html#l00079">qutest_dsl.py:79</a></div></div>
<div class="ttc" id="anamespaceqview_html_a0ac274e7bffb2a1b29949100cd43ca35"><div class="ttname"><a href="namespaceqview.html#a0ac274e7bffb2a1b29949100cd43ca35">qview.main</a></div><div class="ttdeci">def main()</div><div class="ttdef"><b>Definition:</b> <a href="qview_8py_source.html#l01832">qview.py:1832</a></div></div>
<div class="ttc" id="aqs__copy_8h_html_a034206ff7f20a4e6426a5f554434643b"><div class="ttname"><a href="qs__copy_8h.html#a034206ff7f20a4e6426a5f554434643b">QS_OBJ_DICTIONARY</a></div><div class="ttdeci">#define QS_OBJ_DICTIONARY(obj_)</div><div class="ttdoc">Output object dictionary record.</div><div class="ttdef"><b>Definition:</b> <a href="qs__copy_8h_source.html#l00779">qs_copy.h:779</a></div></div>
<div class="ttc" id="aqs__copy_8h_html_a14579f8a23d950a5f2393fa3f9b0e145"><div class="ttname"><a href="qs__copy_8h.html#a14579f8a23d950a5f2393fa3f9b0e145">QS_onTestPost</a></div><div class="ttdeci">void QS_onTestPost(void const *sender, QActive *recipient, QEvt const *e, bool status)</div><div class="ttdoc">callback to examine an event that is about to be posted</div></div>
<div class="ttc" id="aqs__copy_8h_html_a2ed1002d3dda6d95f9f64c59b8453c71"><div class="ttname"><a href="qs__copy_8h.html#a2ed1002d3dda6d95f9f64c59b8453c71">QS_END</a></div><div class="ttdeci">#define QS_END()</div><div class="ttdoc">End a QS record with exiting critical section.</div><div class="ttdef"><b>Definition:</b> <a href="qs__copy_8h_source.html#l00585">qs_copy.h:585</a></div></div>
<div class="ttc" id="aqs__copy_8h_html_a3b1ab21c174f2bec448edec8865a8529"><div class="ttname"><a href="qs__copy_8h.html#a3b1ab21c174f2bec448edec8865a8529">QS_FUN_DICTIONARY</a></div><div class="ttdeci">#define QS_FUN_DICTIONARY(fun_)</div><div class="ttdoc">Output function dictionary record.</div><div class="ttdef"><b>Definition:</b> <a href="qs__copy_8h_source.html#l00795">qs_copy.h:795</a></div></div>
<div class="ttc" id="aqs__copy_8h_html_a3d316077c13f8033c1a391590937e696"><div class="ttname"><a href="qs__copy_8h.html#a3d316077c13f8033c1a391590937e696">QS_onTestSetup</a></div><div class="ttdeci">void QS_onTestSetup(void)</div><div class="ttdoc">callback to setup a unit test inside the Target</div></div>
<div class="ttc" id="aqs__copy_8h_html_a4811826c90b13a0b7137e0443e82d41cae7b17c3ad4c237e9e89693fea1690513"><div class="ttname"><a href="qs__copy_8h.html#a4811826c90b13a0b7137e0443e82d41cae7b17c3ad4c237e9e89693fea1690513">QS_ALL_RECORDS</a></div><div class="ttdeci">@ QS_ALL_RECORDS</div><div class="ttdoc">all maskable QS records</div><div class="ttdef"><b>Definition:</b> <a href="qs__copy_8h_source.html#l00201">qs_copy.h:201</a></div></div>
<div class="ttc" id="aqs__copy_8h_html_a9342913835bccef5ded5a59d2712101a"><div class="ttname"><a href="qs__copy_8h.html#a9342913835bccef5ded5a59d2712101a">QS_FUN</a></div><div class="ttdeci">#define QS_FUN(fun_)</div><div class="ttdoc">Output formatted function pointer to the QS record.</div><div class="ttdef"><b>Definition:</b> <a href="qs__copy_8h_source.html#l00686">qs_copy.h:686</a></div></div>
<div class="ttc" id="aqs__copy_8h_html_aa3e19e4d0d7a2075951ac5c3fe389936"><div class="ttname"><a href="qs__copy_8h.html#aa3e19e4d0d7a2075951ac5c3fe389936">QS_I32</a></div><div class="ttdeci">#define QS_I32(width_, data_)</div><div class="ttdoc">Output formatted int32_t to the QS record.</div><div class="ttdef"><b>Definition:</b> <a href="qs__copy_8h_source.html#l00632">qs_copy.h:632</a></div></div>
<div class="ttc" id="aqs__copy_8h_html_aa56a51195cc2819fb2612e3c24723bae"><div class="ttname"><a href="qs__copy_8h.html#aa56a51195cc2819fb2612e3c24723bae">QS_I16</a></div><div class="ttdeci">#define QS_I16(width_, data_)</div><div class="ttdoc">Output formatted int16_t to the QS record.</div><div class="ttdef"><b>Definition:</b> <a href="qs__copy_8h_source.html#l00624">qs_copy.h:624</a></div></div>
<div class="ttc" id="aqs__copy_8h_html_abefe60a3ba6b11d5406bba4708a48f2d"><div class="ttname"><a href="qs__copy_8h.html#abefe60a3ba6b11d5406bba4708a48f2d">QS_onTestTeardown</a></div><div class="ttdeci">void QS_onTestTeardown(void)</div><div class="ttdoc">callback to teardown after a unit test inside the Target</div></div>
<div class="ttc" id="aqs__copy_8h_html_acdb495c1e5524b5d95aaff82c47f6db5a48cec974671d01f280b2b1a33225d176"><div class="ttname"><a href="qs__copy_8h.html#acdb495c1e5524b5d95aaff82c47f6db5a48cec974671d01f280b2b1a33225d176">QS_USER</a></div><div class="ttdeci">@ QS_USER</div><div class="ttdoc">the first record available to QS users</div><div class="ttdef"><b>Definition:</b> <a href="qs__copy_8h_source.html#l00197">qs_copy.h:196</a></div></div>
<div class="ttc" id="aqs__copy_8h_html_ad3f890b82210f9d63348d9764bdc1073"><div class="ttname"><a href="qs__copy_8h.html#ad3f890b82210f9d63348d9764bdc1073">QS_onTestEvt</a></div><div class="ttdeci">void QS_onTestEvt(QEvt *e)</div><div class="ttdoc">callback to &quot;massage&quot; the test event before dispatching/posting it</div></div>
<div class="ttc" id="aqs__copy_8h_html_af22371611fe57862a37eb785debb7921"><div class="ttname"><a href="qs__copy_8h.html#af22371611fe57862a37eb785debb7921">QS_INIT</a></div><div class="ttdeci">#define QS_INIT(arg_)</div><div class="ttdoc">Initialize the QS facility.</div><div class="ttdef"><b>Definition:</b> <a href="qs__copy_8h_source.html#l00424">qs_copy.h:424</a></div></div>
<div class="ttc" id="aqs__copy_8h_html_af824d5b11fdd09d1bb4775c9b32e4530"><div class="ttname"><a href="qs__copy_8h.html#af824d5b11fdd09d1bb4775c9b32e4530">QS_onCommand</a></div><div class="ttdeci">void QS_onCommand(uint8_t cmdId, uint32_t param1, uint32_t param2, uint32_t param3)</div><div class="ttdoc">Callback function to execute user commands (to be implemented in BSP)</div></div>
</div><!-- fragment --><dl class="tag">
<dt>1</dt>
<dd>The <code>"qpc.h"</code> header file contains the <a href="https://www.state-machine.com/qpc/">QP/C framework</a> API, which includes the QUTest interface. Typically, you need to include this header file in QUTest test doubles. <blockquote class="doxtable">
<p><b>NOTE:</b> for test fixtures based on the <a href="https://www.state-machine.com/qpcpp/">QP/C++ framework</a>, you need to include the <code>"qpcpp.h"</code> header file. </p>
</blockquote>
</dd>
<dt>2</dt>
<dd>You also need to include the interface to the CUT, which is <code>ProductionCode.h</code> in this case.  </dd>
<dt>3</dt>
<dd>The macro <code>Q_DEFINE_THIS_FILE</code> is needed for <a href="https://www.state-machine.com/glossary#assertion" class="extern"><b>DbC assertions</b></a> (they have nothing to do with <a href="https://www.state-machine.com/glossary#test_assertion" class="extern">test assertions</a>). Later in this file, a <a href="https://www.state-machine.com/glossary#assertion" class="extern">DbC assertion</a> is used to guard against failure in the initialization of the <a class="el" href="qs.html">QS</a> target-resident component (see step [7]).  </dd>
<dt>4</dt>
<dd>The variable <code>Counter</code> is used to control the return value from the CUT (see <a class="el" href="qutest_unity.html#qutest_tut_basic-cut">ProductionCode.c</a> line 4). <blockquote class="doxtable">
<p><b>NOTE:</b> this approach breaks encapsulation of the CUT, but it is copied here from the original Unity test. </p>
</blockquote>
</dd>
<dt>5</dt>
<dd>A QUTest <em>test fixture</em> code needs the <code><a class="el" href="namespaceqview.html#a0ac274e7bffb2a1b29949100cd43ca35">main()</a></code> function. This <code><a class="el" href="namespaceqview.html#a0ac274e7bffb2a1b29949100cd43ca35">main()</a></code> function can be in a separate file, but in this simple example it is placed in <code>test_ProductionCode.c</code>. Either way, the <code><a class="el" href="namespaceqview.html#a0ac274e7bffb2a1b29949100cd43ca35">main()</a></code> function has the usual structure of a QP/C application (and in fact in the more advanced tests it can be <em>the same</em> function as used by the actual QP/C application). But here, it contains the bare minimum function calls, as described below.  </dd>
<dt>6</dt>
<dd>The <code><a class="el" href="namespaceqview.html#a0ac274e7bffb2a1b29949100cd43ca35">main()</a></code> function must start with calling <code>QF_init()</code> to initialize the QP framework.  </dd>
<dt>7</dt>
<dd>Next, you need to initialize the <a class="el" href="qs.html">QS</a> target-resident component (<a class="el" href="qs__copy_8h.html#af22371611fe57862a37eb785debb7921" title="Initialize the QS facility.">QS_INIT()</a>). This macro is wrapped with the <a href="https://www.state-machine.com/qpc/qassert_8h.html#aa0c75140aa3855c94e453b06567dcc28" class="extern"><b>Q_ALLEGE()</b></a> assertion, which will fire if the QS initialization fails. (In which case continuationon of the test makes no sense).  </dd>
<dt>8-10</dt>
<dd>Next, you produce <a class="el" href="qs.html#qs_dict">QS dictionaries</a> for all functions you wish to test as well as objects you might need to inspect. <blockquote class="doxtable">
<p><b>NOTE:</b> you need to do this, so that the test scripts can refer to the functions and objects by the same symbolic names as the CUT/test-fixture. </p>
</blockquote>
</dd>
<dt>11</dt>
<dd>The QS_FILTER_ON() macro sets the <a class="el" href="qs.html#qs_global">global filter</a> in the Target. Here all output is enabled (<a class="el" href="qs__copy_8h.html#a4811826c90b13a0b7137e0443e82d41cae7b17c3ad4c237e9e89693fea1690513" title="all maskable QS records">QS_ALL_RECORDS</a>).  </dd>
<dt>12</dt>
<dd>Finally, at the end of <code><a class="el" href="namespaceqview.html#a0ac274e7bffb2a1b29949100cd43ca35">main()</a></code> you need to call <code>QF_run()</code> to run the tests.  </dd>
<dt>13</dt>
<dd>The callback function <code><a class="el" href="qs__copy_8h.html#a3d316077c13f8033c1a391590937e696" title="callback to setup a unit test inside the Target">QS_onTestSetup()</a></code> allows you to include code that will be run at the beginning of each test. Here this simple CUT does not need any setup, but you still need to provide (an empty) implementation to satisfy the linker.  </dd>
<dt>14</dt>
<dd>The callback function <code><a class="el" href="qs__copy_8h.html#abefe60a3ba6b11d5406bba4708a48f2d" title="callback to teardown after a unit test inside the Target">QS_onTestTeardown()</a></code> allows you to include code that will be run at the end of each test. Here this simple CUT does not need any teardown, but you still need to provide (an empty) implementation to satisfy the linker.  </dd>
<dt>15</dt>
<dd>The callback function <code><a class="el" href="qs__copy_8h.html#af824d5b11fdd09d1bb4775c9b32e4530" title="Callback function to execute user commands (to be implemented in BSP)">QS_onCommand()</a></code> allows you to remotely execute commands inside the Target. Here is where you execute the CUT and report results back to QSPY.  </dd>
<dt>16</dt>
<dd>The command with <code>cmdId==0</code> will be used to call the <code>FindFunction_WhichIsBroken()</code> CUT. <blockquote class="doxtable">
<p><b>NOTE:</b> You can use other <code>cmdId</code>s to call other pieces of CUT or to provide different variants of calling the same CUT, as you see fit. Much of the art of writing <em>test fixtures</em> lies in constructing flexible remote commands that exercise your CUT. </p>
</blockquote>
</dd>
<dt>17</dt>
<dd>The <code>QS_BEGIN()</code> macro starts the <a class="el" href="qs.html#qs_app">application-specific</a> trace record that will report results of calling the <code>FindFunction_WhichIsBroken()</code> CUT to the test script.  </dd>
<dt>18</dt>
<dd>The <code><a class="el" href="qs__copy_8h.html#a9342913835bccef5ded5a59d2712101a" title="Output formatted function pointer to the QS record.">QS_FUN()</a></code> macro sends the address of the function to the test script. This address will be converted to the name of the function, because the dictionary for this function has been generated in setp 8.  </dd>
<dt>19</dt>
<dd>The <code><a class="el" href="qs__copy_8h.html#aa3e19e4d0d7a2075951ac5c3fe389936" title="Output formatted int32_t to the QS record.">QS_I32()</a></code> macro sends a 32-bit signed integer (<code>int32_t</code>) to the test script. Here you output the return value from <code>FindFunction_WhichIsBroken()</code>.  </dd>
<dt>20</dt>
<dd>The <code><a class="el" href="qs__copy_8h.html#aa56a51195cc2819fb2612e3c24723bae" title="Output formatted int16_t to the QS record.">QS_I16()</a></code> macro sends a 16-bit signed integer (<code>int16_t</code>) to the test script. Here you output the argument passed to <code>FindFunction_WhichIsBroken()</code>.  </dd>
<dt>21</dt>
<dd>The <code><a class="el" href="qs__copy_8h.html#a2ed1002d3dda6d95f9f64c59b8453c71" title="End a QS record with exiting critical section.">QS_END()</a></code> macro ends the <a class="el" href="qs.html#qs_app">application-specific</a> trace record.  <br  />
 </dd>
<dt>22</dt>
<dd>The command with <code>cmdId==1</code> will be used to call the <code>FunctionWhichReturnsLocalVariable()</code> CUT.  </dd>
<dt>23-26</dt>
<dd>Again, the <a class="el" href="qs.html#qs_app">application-specific</a> trace record gets generated that reports the function address and the return value from this function call.  <br  />
 </dd>
<dt>27</dt>
<dd>The <code><a class="el" href="qs__copy_8h.html#ad3f890b82210f9d63348d9764bdc1073" title="callback to &quot;massage&quot; the test event before dispatching/posting it">QS_onTestEvt()</a></code> callback function is not used in this test, but needs to be provided to satisfy the linker.  </dd>
<dt>28</dt>
<dd>The <code><a class="el" href="qs__copy_8h.html#a14579f8a23d950a5f2393fa3f9b0e145" title="callback to examine an event that is about to be posted">QS_onTestPost()</a></code> callback function is not used in this test, but needs to be provided to satisfy the linker.  </dd>
</dl>
<div style="clear:both;"></div><h1><a class="anchor" id="qutest_unity-script"></a>
Test Script</h1>
<p>A <b>test script</b> contains a group of related tests (a <em>"test group"</em>). The basic job of these tests is to send inputs to the <em>test fixture</em> running in the Target and to compare the produced <a class="el" href="qspy_text.html">QSPY textual output</a> with the <b>expectations</b> of the test. The following listing shows the <em>test script</em> (Python) for the Unity basic tests (file <span class="img file_py"><code>test_ProductionCode.py</code></span>). The explanation section following the listing clarifies the interesting lines of code (lines starting with <code>[xx]</code> labels).</p>
<dl class="section remark"><dt>Remarks</dt><dd>Even though a <em>test script</em> uses <b>Python</b> under the hood, you don"t need to be a Python expert to write effective test scripts. The actual set of commands that you use and need to know about forms a small @ref qutest_script "Domain Specific Language (DSL) for unit testing", which just happens to be implemented with Python as a command interpreter.</dd></dl>
<dl class="section note"><dt>Note</dt><dd>The following test script performs the same tests as the Unity test fixture <span class="img file_c"><code>TestProductionCode.c</code></span> in the directory <span class="img folder"><code>qpc\examples\qutest\unity_basic\test_unity</code></span>.</dd></dl>
<div class="fragment"><div class="line"> [1] <span class="comment"># QUTEST script corresponding to the test_ProductionCode.c test fixture.</span></div>
<div class="line">     <span class="comment"># This test fixture corresponds to ../test_unity/TestProductionCode.c fixture.</span></div>
<div class="line">     <span class="comment"># see https://www.state-machine.com/qtools/qutest.html</span></div>
<div class="line"> </div>
<div class="line">     <span class="comment"># preamble...</span></div>
<div class="line"> [2] <span class="keyword">def </span><a class="code" href="namespacequtest__dsl.html#a72c6919e936aff35c5a88dc715bde8a0">on_setup</a>():</div>
<div class="line">         <span class="comment"># This is run before EACH TEST</span></div>
<div class="line"> [3]     <a class="code" href="namespacequtest__dsl.html#ac890232d1de79547ba5485953f84ac66">current_obj</a>(OBJ_AP, <span class="stringliteral">&quot;Counter&quot;</span>)</div>
<div class="line"> [4]     <a class="code" href="namespacequtest__dsl.html#a3fb35bbc1071d49a9758de298a5269a1">poke</a>(0, 4, <a class="code" href="namespacequtest__dsl.html#a545b328b74868e098771c12493f7896a">pack</a>(<span class="stringliteral">&quot;&lt;L&quot;</span>, 0x5A5A))</div>
<div class="line"> </div>
<div class="line">     <span class="comment"># tests...</span></div>
<div class="line"> [5] <a class="code" href="namespacequtest__dsl.html#a428afa0df76f435f6a7b3c201bdb846c">test</a>(<span class="stringliteral">&quot;FindFunction_WhichIsBroken() Should Return Zero If Item Is Not In List, Which Works Even In Our Broken Code&quot;</span>)</div>
<div class="line">     <span class="comment"># All of these should pass</span></div>
<div class="line"> [6] <a class="code" href="namespacequtest__dsl.html#a6badcb644f2efeaf1da70e762a0821fe">command</a>(0, 78)</div>
<div class="line"> [7] <a class="code" href="namespacequtest__dsl.html#a0489cc93c36a171881ff0c198e08f4f2">expect</a>(<span class="stringliteral">&quot;0000000001 USER+000 FindFunction_WhichIsBroken 0 78&quot;</span>)</div>
<div class="line"> [8] <a class="code" href="namespacequtest__dsl.html#a0489cc93c36a171881ff0c198e08f4f2">expect</a>(<span class="stringliteral">&quot;0000000002 Trg-Done QS_RX_COMMAND&quot;</span>)</div>
<div class="line">     <a class="code" href="namespacequtest__dsl.html#a6badcb644f2efeaf1da70e762a0821fe">command</a>(0, 1)</div>
<div class="line">     <a class="code" href="namespacequtest__dsl.html#a0489cc93c36a171881ff0c198e08f4f2">expect</a>(<span class="stringliteral">&quot;0000000003 USER+000 FindFunction_WhichIsBroken 0 1&quot;</span>)</div>
<div class="line">     <a class="code" href="namespacequtest__dsl.html#a0489cc93c36a171881ff0c198e08f4f2">expect</a>(<span class="stringliteral">&quot;0000000004 Trg-Done QS_RX_COMMAND&quot;</span>)</div>
<div class="line">     <a class="code" href="namespacequtest__dsl.html#a6badcb644f2efeaf1da70e762a0821fe">command</a>(0, 33)</div>
<div class="line"> [9] <a class="code" href="namespacequtest__dsl.html#a0489cc93c36a171881ff0c198e08f4f2">expect</a>(<span class="stringliteral">&quot;@timestamp USER+000 FindFunction_WhichIsBroken 0 33&quot;</span>)</div>
<div class="line">     <a class="code" href="namespacequtest__dsl.html#a0489cc93c36a171881ff0c198e08f4f2">expect</a>(<span class="stringliteral">&quot;@timestamp Trg-Done QS_RX_COMMAND&quot;</span>)</div>
<div class="line">     <a class="code" href="namespacequtest__dsl.html#a6badcb644f2efeaf1da70e762a0821fe">command</a>(0, 999)</div>
<div class="line">     <a class="code" href="namespacequtest__dsl.html#a0489cc93c36a171881ff0c198e08f4f2">expect</a>(<span class="stringliteral">&quot;@timestamp USER+000 FindFunction_WhichIsBroken 0 999&quot;</span>)</div>
<div class="line">     <a class="code" href="namespacequtest__dsl.html#a0489cc93c36a171881ff0c198e08f4f2">expect</a>(<span class="stringliteral">&quot;@timestamp Trg-Done QS_RX_COMMAND&quot;</span>)</div>
<div class="line">[10] <a class="code" href="namespacequtest__dsl.html#a6badcb644f2efeaf1da70e762a0821fe">command</a>(0, (-1) &amp; 0xFFFFFFFF)</div>
<div class="line">     <a class="code" href="namespacequtest__dsl.html#a0489cc93c36a171881ff0c198e08f4f2">expect</a>(<span class="stringliteral">&quot;@timestamp USER+000 FindFunction_WhichIsBroken 0 -1&quot;</span>)</div>
<div class="line">     <a class="code" href="namespacequtest__dsl.html#a0489cc93c36a171881ff0c198e08f4f2">expect</a>(<span class="stringliteral">&quot;@timestamp Trg-Done QS_RX_COMMAND&quot;</span>)</div>
<div class="line"> </div>
<div class="line">[11] <a class="code" href="namespacequtest__dsl.html#a428afa0df76f435f6a7b3c201bdb846c">test</a>(<span class="stringliteral">&quot;FindFunction_WhichIsBroken() Should Return The Index For Items In List, Which Will Fail Because Our Function Under Test Is Broken&quot;</span>)</div>
<div class="line">[12] <a class="code" href="namespacequtest__dsl.html#a6badcb644f2efeaf1da70e762a0821fe">command</a>(0, 34)</div>
<div class="line">[13] <a class="code" href="namespacequtest__dsl.html#a0489cc93c36a171881ff0c198e08f4f2">expect</a>(<span class="stringliteral">&quot;@timestamp USER+000 FindFunction_WhichIsBroken 1 34&quot;</span>)</div>
<div class="line">     <span class="comment"># Notice the rest of these didn&quot;t get a chance to run because the line above failed.</span></div>
<div class="line">     <span class="comment"># Unit tests abort each test on the first sign of trouble.</span></div>
<div class="line">     <span class="comment"># Then NEXT test runs as normal.</span></div>
<div class="line">     <a class="code" href="namespacequtest__dsl.html#a0489cc93c36a171881ff0c198e08f4f2">expect</a>(<span class="stringliteral">&quot;@timestamp Trg-Done QS_RX_COMMAND&quot;</span>)</div>
<div class="line">     <a class="code" href="namespacequtest__dsl.html#a6badcb644f2efeaf1da70e762a0821fe">command</a>(0, 8888)</div>
<div class="line">     <a class="code" href="namespacequtest__dsl.html#a0489cc93c36a171881ff0c198e08f4f2">expect</a>(<span class="stringliteral">&quot;@timestamp USER+000 FindFunction_WhichIsBroken 8 8888&quot;</span>)</div>
<div class="line">     <a class="code" href="namespacequtest__dsl.html#a0489cc93c36a171881ff0c198e08f4f2">expect</a>(<span class="stringliteral">&quot;@timestamp Trg-Done QS_RX_COMMAND&quot;</span>)</div>
<div class="line"> </div>
<div class="line">[14] <a class="code" href="namespacequtest__dsl.html#a428afa0df76f435f6a7b3c201bdb846c">test</a>(<span class="stringliteral">&quot;FunctionWhichReturnsLocalVariable() Should Return The Current Counter Value&quot;</span>)</div>
<div class="line">[15] <a class="code" href="namespacequtest__dsl.html#a6badcb644f2efeaf1da70e762a0821fe">command</a>(1)</div>
<div class="line">     <a class="code" href="namespacequtest__dsl.html#a0489cc93c36a171881ff0c198e08f4f2">expect</a>(<span class="stringliteral">&quot;@timestamp USER+001 FunctionWhichReturnsLocalVariable 0x5A5A&quot;</span>)</div>
<div class="line">     <a class="code" href="namespacequtest__dsl.html#a0489cc93c36a171881ff0c198e08f4f2">expect</a>(<span class="stringliteral">&quot;@timestamp Trg-Done QS_RX_COMMAND&quot;</span>)</div>
<div class="line">     <span class="comment"># This should be true because we can still change our answer</span></div>
<div class="line">[16] <a class="code" href="namespacequtest__dsl.html#a3fb35bbc1071d49a9758de298a5269a1">poke</a>(0, 4, <a class="code" href="namespacequtest__dsl.html#a545b328b74868e098771c12493f7896a">pack</a>(<span class="stringliteral">&quot;&lt;L&quot;</span>, 0x1234))</div>
<div class="line">     <a class="code" href="namespacequtest__dsl.html#a6badcb644f2efeaf1da70e762a0821fe">command</a>(1)</div>
<div class="line">     <a class="code" href="namespacequtest__dsl.html#a0489cc93c36a171881ff0c198e08f4f2">expect</a>(<span class="stringliteral">&quot;@timestamp USER+001 FunctionWhichReturnsLocalVariable 0x1234&quot;</span>)</div>
<div class="line">     <a class="code" href="namespacequtest__dsl.html#a0489cc93c36a171881ff0c198e08f4f2">expect</a>(<span class="stringliteral">&quot;@timestamp Trg-Done QS_RX_COMMAND&quot;</span>)</div>
<div class="line"> </div>
<div class="line">[17] <a class="code" href="namespacequtest__dsl.html#a428afa0df76f435f6a7b3c201bdb846c">test</a>(<span class="stringliteral">&quot;FunctionWhichReturnsLocalVariable() Should Return The Current Counter Value Again&quot;</span>, NORESET)</div>
<div class="line">     <span class="comment"># This should be true again because setup was rerun before this test (and after we changed it to 0x1234)</span></div>
<div class="line">     <a class="code" href="namespacequtest__dsl.html#a6badcb644f2efeaf1da70e762a0821fe">command</a>(1)</div>
<div class="line">     <a class="code" href="namespacequtest__dsl.html#a0489cc93c36a171881ff0c198e08f4f2">expect</a>(<span class="stringliteral">&quot;@timestamp USER+001 FunctionWhichReturnsLocalVariable 0x5A5A&quot;</span>)</div>
<div class="line">     <a class="code" href="namespacequtest__dsl.html#a0489cc93c36a171881ff0c198e08f4f2">expect</a>(<span class="stringliteral">&quot;@timestamp Trg-Done QS_RX_COMMAND&quot;</span>)</div>
<div class="line"> </div>
<div class="line">     <a class="code" href="namespacequtest__dsl.html#a428afa0df76f435f6a7b3c201bdb846c">test</a>(<span class="stringliteral">&quot;FunctionWhichReturnsLocalVariable() Should Return Current Counter, But Fails Because This Test Is Actually Flawed&quot;</span>, NORESET)</div>
<div class="line">     <span class="comment"># Sometimes you get the test wrong.  When that happens, you get a failure too... and a quick look should tell</span></div>
<div class="line">     <span class="comment"># you what actually happened...which in this case was a failure to setup the initial condition.</span></div>
<div class="line">     <a class="code" href="namespacequtest__dsl.html#a6badcb644f2efeaf1da70e762a0821fe">command</a>(1)</div>
<div class="line">     <a class="code" href="namespacequtest__dsl.html#a0489cc93c36a171881ff0c198e08f4f2">expect</a>(<span class="stringliteral">&quot;@timestamp USER+001 FunctionWhichReturnsLocalVariable 0x1234&quot;</span>)</div>
<div class="line">     <a class="code" href="namespacequtest__dsl.html#a0489cc93c36a171881ff0c198e08f4f2">expect</a>(<span class="stringliteral">&quot;@timestamp Trg-Done QS_RX_COMMAND&quot;</span>)</div>
<div class="ttc" id="anamespacequtest__dsl_html_a0489cc93c36a171881ff0c198e08f4f2"><div class="ttname"><a href="namespacequtest__dsl.html#a0489cc93c36a171881ff0c198e08f4f2">qutest_dsl.expect</a></div><div class="ttdeci">def expect(match)</div><div class="ttdoc">defines an expectation for the current test</div><div class="ttdef"><b>Definition:</b> <a href="qutest__dsl_8py_source.html#l00174">qutest_dsl.py:174</a></div></div>
<div class="ttc" id="anamespacequtest__dsl_html_a3fb35bbc1071d49a9758de298a5269a1"><div class="ttname"><a href="namespacequtest__dsl.html#a3fb35bbc1071d49a9758de298a5269a1">qutest_dsl.poke</a></div><div class="ttdeci">def poke(offset, size, data)</div><div class="ttdoc">pokes data into the Target.</div><div class="ttdef"><b>Definition:</b> <a href="qutest__dsl_8py_source.html#l00542">qutest_dsl.py:542</a></div></div>
<div class="ttc" id="anamespacequtest__dsl_html_a428afa0df76f435f6a7b3c201bdb846c"><div class="ttname"><a href="namespacequtest__dsl.html#a428afa0df76f435f6a7b3c201bdb846c">qutest_dsl.test</a></div><div class="ttdeci">def test(title, opt=0)</div><div class="ttdoc">start a new test</div><div class="ttdef"><b>Definition:</b> <a href="qutest__dsl_8py_source.html#l00120">qutest_dsl.py:120</a></div></div>
<div class="ttc" id="anamespacequtest__dsl_html_a545b328b74868e098771c12493f7896a"><div class="ttname"><a href="namespacequtest__dsl.html#a545b328b74868e098771c12493f7896a">qutest_dsl.pack</a></div><div class="ttdeci">def pack(format, v1, v2)</div><div class="ttdoc">packs data into binary string to be sent to QSPY.</div><div class="ttdef"><b>Definition:</b> <a href="qutest__dsl_8py_source.html#l00584">qutest_dsl.py:584</a></div></div>
<div class="ttc" id="anamespacequtest__dsl_html_a6badcb644f2efeaf1da70e762a0821fe"><div class="ttname"><a href="namespacequtest__dsl.html#a6badcb644f2efeaf1da70e762a0821fe">qutest_dsl.command</a></div><div class="ttdeci">def command(cmdId, param1=0, param2=0, param3=0)</div><div class="ttdoc">executes a given command in the Target</div><div class="ttdef"><b>Definition:</b> <a href="qutest__dsl_8py_source.html#l00411">qutest_dsl.py:411</a></div></div>
<div class="ttc" id="anamespacequtest__dsl_html_a72c6919e936aff35c5a88dc715bde8a0"><div class="ttname"><a href="namespacequtest__dsl.html#a72c6919e936aff35c5a88dc715bde8a0">qutest_dsl.on_setup</a></div><div class="ttdeci">def on_setup()</div><div class="ttdoc">callback function invoked at the beginning of each test</div><div class="ttdef"><b>Definition:</b> <a href="qutest__dsl_8py_source.html#l00592">qutest_dsl.py:592</a></div></div>
<div class="ttc" id="anamespacequtest__dsl_html_ac890232d1de79547ba5485953f84ac66"><div class="ttname"><a href="namespacequtest__dsl.html#ac890232d1de79547ba5485953f84ac66">qutest_dsl.current_obj</a></div><div class="ttdeci">def current_obj(obj_kind, obj_id)</div><div class="ttdoc">Set the Current-Object in the Target.</div><div class="ttdef"><b>Definition:</b> <a href="qutest__dsl_8py_source.html#l00289">qutest_dsl.py:289</a></div></div>
</div><!-- fragment --><dl class="tag">
<dt>1</dt>
<dd>Lines starting with a pound sign ('#') or empty lines are comments which are ignored by QUTest.  </dd>
</dl>
<div style="clear:both;"></div><p><b>"preamble"</b> defines the startup code common to all tests in the group: </p><dl class="tag">
<dt>2</dt>
<dd>The function <a class="el" href="namespacequtest__dsl.html#a72c6919e936aff35c5a88dc715bde8a0" title="callback function invoked at the beginning of each test">on_setup()</a> is executed at the beginning of each test in the group (see <a class="el" href="namespacequtest__dsl.html#a428afa0df76f435f6a7b3c201bdb846c" title="start a new test">test()</a>), including both tests that reset and do not reset the Target.  </dd>
<dt>3</dt>
<dd>The <a class="el" href="namespacequtest__dsl.html#ac890232d1de79547ba5485953f84ac66" title="Set the Current-Object in the Target.">current_obj()</a> command sets the "current object" of the application-specific kind (<code>OBJ_AP</code>) in the Target. Subsequent commands (such as <a class="el" href="namespacequtest__dsl.html#a3fb35bbc1071d49a9758de298a5269a1" title="pokes data into the Target.">poke()</a> in the next step) will act on this "current object".  </dd>
<dt>4</dt>
<dd>The <a class="el" href="namespacequtest__dsl.html#a3fb35bbc1071d49a9758de298a5269a1" title="pokes data into the Target.">poke()</a> command pokes the specified "Application Current Object" starting with the specified offset from the beginning of the object in memory (here 0) with the data elements of size 4 (the second argument) with the data provided in the third argument <code><a class="el" href="namespacequtest__dsl.html#a545b328b74868e098771c12493f7896a" title="packs data into binary string to be sent to QSPY.">pack()</a></code> "pack("&lt;L", 0x5A5A)" into the previously established "Application Current Object".  </dd>
</dl>
<div style="clear:both;"></div><p><b>Test: "FindFunction_WhichIsBroken() Should Return Zero..."</b> checks that the CUT returns 0 when a given number is not found: </p><dl class="tag">
<dt>5</dt>
<dd>The <a class="el" href="namespacequtest__dsl.html#a428afa0df76f435f6a7b3c201bdb846c" title="start a new test">test()</a> command starts a test and gives it a name (in double quotes). The name of test will be displayed as the test is executed and should be a quick reminder about the objective of this test. This test command also <a class="el" href="qutest_rtc.html#qutest_reset">resets the Target</a>, which brings the Target into a well-defined initial state and produces the <a class="el" href="qs.html#qs_dict">QS dictionary records</a> (see <a class="el" href="qutest_unity.html#qutest_unity-fixture">test-fixture</a>[12]) <blockquote class="doxtable">
<p><b>NOTE:</b> The ability to perform the <b>full Target reset</b> is a unique feature of QUTest. Other unit testing frameworks, including Unity and CppUTest, don't reset the Target. They merely call the test <code>setup()/tearDown()</code> functions at the beginning and end of the test, respectively. QUTest also calls <code>onReset()/onSetup()/onTeardown()</code>, but obviously the full Target reset is a much better guarantee that the Target starts in exactly the same state. </p>
</blockquote>
</dd>
<dt>6</dt>
<dd>The <a class="el" href="namespacequtest__dsl.html#a6badcb644f2efeaf1da70e762a0821fe" title="executes a given command in the Target">command()</a> command causes the invocation of the <code><a class="el" href="qs__copy_8h.html#af824d5b11fdd09d1bb4775c9b32e4530" title="Callback function to execute user commands (to be implemented in BSP)">QS_onCommand()</a></code> callback inside the Target. The argument 0 is the <code>cmdId</code> parameter (see <a class="el" href="qutest_unity.html#qutest_unity-fixture">test-fixture</a>[16]) <blockquote class="doxtable">
<p><b>NOTE:</b> The first parameter of <a class="el" href="namespacequtest__dsl.html#a6badcb644f2efeaf1da70e762a0821fe" title="executes a given command in the Target">command()</a> "command" here is just a number (0), but it is also possible to use a <b>symbolic name</b> for the first parameter. This symbolic name will be looked up in the user dictionary (<a class="el" href="qs__copy_8h.html#ae75893daa66c6d0b5a6dfb8f3fca1196" title="Output user QS-record dictionary record.">QS_USR_DICTIONARY()</a>) </p>
</blockquote>
</dd>
<dt>7</dt>
<dd>The <a class="el" href="namespacequtest__dsl.html#a0489cc93c36a171881ff0c198e08f4f2" title="defines an expectation for the current test">expect()</a> command represents an <b>expectation</b> of this test (a.k.a. <a href="https://www.state-machine.com/glossary#test_assertion">test assertion</a>). This is the expected output generated by the <code>command(0)</code> command from the previous step. You need to consult the test fixture to determine what you should expect in this case. <blockquote class="doxtable">
<p><b>NOTE:</b> the expected string starts with a number <code>0000000001</code>, which is the <a class="el" href="qs.html#qs_tstamp">Target Time-Stamp</a>. In QUTest, the "timestamp" simply counts all the QS trace records produced, so that you know that no entries have been lost. In the later tests you will see how you can count the steps <b>automatically</b> with the <code>@timestamp</code> placeholder. </p>
</blockquote>
</dd>
<dt>8</dt>
<dd>The test finishes with the expectation for the <code>Trg-Done QS_RX_COMMAND</code> trace record, which means that all output generated by <a class="el" href="namespacequtest__dsl.html#a6badcb644f2efeaf1da70e762a0821fe" title="executes a given command in the Target">command()</a> has been generated.  </dd>
<dt>9</dt>
<dd>This <a class="el" href="namespacequtest__dsl.html#a0489cc93c36a171881ff0c198e08f4f2" title="defines an expectation for the current test">expect()</a> command illustrate the use of the <code>@timestamp</code> placeholder to account for the test steps <b>automatically</b>.  </dd>
<dt>10</dt>
<dd>This <a class="el" href="namespacequtest__dsl.html#a6badcb644f2efeaf1da70e762a0821fe" title="executes a given command in the Target">command()</a> illustrates how to pass <b>negative numbers</b> as arguments. As you can see, you need to binary-and the number with the all-bits-on bitmask <code>0xFFFFFFFF</code>.  </dd>
</dl>
<div style="clear:both;"></div><p><b>Test: "FindFunction_WhichIsBroken() Should Return The Index..."</b> checks that the CUT fails to return the expected index, because of the internal bug: </p><dl class="tag">
<dt>11</dt>
<dd>The <a class="el" href="namespacequtest__dsl.html#a428afa0df76f435f6a7b3c201bdb846c" title="start a new test">test()</a> command starts a next test.  </dd>
<dt>12</dt>
<dd>This <code>command(0, 34)</code> should cause the function <code>FindFunction_WhichIsBroken()</code> to return index <code>1</code>, because the number <code>34</code> is actually in the list.  </dd>
<dt>13</dt>
<dd>This <a class="el" href="namespacequtest__dsl.html#a0489cc93c36a171881ff0c198e08f4f2" title="defines an expectation for the current test">expect()</a> command codifies the expected result of the function call. <blockquote class="doxtable">
<p><b>NOTE:</b> Due to the bug in the CUT, however, the expectation will fail, in which case the rest of the test is skipped until the <b>next</b> <a class="el" href="namespacequtest__dsl.html#a428afa0df76f435f6a7b3c201bdb846c" title="start a new test">test()</a> command. </p>
</blockquote>
</dd>
</dl>
<div style="clear:both;"></div><p><b>Test: "FunctionWhichReturnsLocalVariable() Should Return The Current Counter Value"</b>: </p><dl class="tag">
<dt>14</dt>
<dd>The <a class="el" href="namespacequtest__dsl.html#a428afa0df76f435f6a7b3c201bdb846c" title="start a new test">test()</a> command starts a next test.  </dd>
<dt>15</dt>
<dd>This <code>command(1)</code> runs the second function <code>FunctionWhichReturnsLocalVariable()</code> in the CUT.  </dd>
<dt>16</dt>
<dd>This <a class="el" href="namespacequtest__dsl.html#a3fb35bbc1071d49a9758de298a5269a1" title="pokes data into the Target.">poke()</a> command changes the value of the <code>Counter</code> variable, because this is the "current AP object" established in the <a class="el" href="namespacequtest__dsl.html#a72c6919e936aff35c5a88dc715bde8a0" title="callback function invoked at the beginning of each test">on_setup()</a> callback in step [3].  </dd>
</dl>
<div style="clear:both;"></div><dl class="section attention"><dt>Attention</dt><dd>The QSPY host application limits the <a class="el" href="qs.html#qs_dict">QS dictionaries</a> to the <b>first 63 characters</b>. This means that longer names of functions or objects will be <b>truncated</b> to this limit. Please keep this limit in mind when choosing various names in your application.</dd></dl>
<p><b>Test: "FunctionWhichReturnsLocalVariable() Should Return The Current Counter..."</b> checks whether <code>FunctionWhichReturnsLocalVariable()</code> CUT returns the value poked into the <code>Counter</code> variable: </p><dl class="tag">
<dt>17</dt>
<dd>The <a class="el" href="namespacequtest__dsl.html#a428afa0df76f435f6a7b3c201bdb846c" title="start a new test">test()</a> command starts a next test. <blockquote class="doxtable">
<p><b>NOTE:</b> Unlike all previous tests so far, this test does <b>not</b> reset the Target (argument <a class="el" href="qutest_rtc.html#qutest_reset">NORESET</a>) </p>
</blockquote>
</dd>
</dl>
<div style="clear:both;"></div><dl class="section remark"><dt>Remarks</dt><dd>As an exercise you should modify the file <code>ProductionCode.c</code> to fix the bug and make the tests pass.</dd></dl>
<h1><a class="anchor" id="qutest_unity-embed"></a>
Running the Test on Embedded Targets</h1>
<p>As mentioned at the initial description of this example, the directory <span class="img folder"><code>C:\qp\qpc\examples\qutest\unity_basic\test</code></span> contains makefiles to build the code and run the tests on the embedded boards (TivaC LaunchPad from Texas Instruments and EFM32 Pearl-Gecko board from Silicon Labs). Both these boards open a virtual COM port on the machine they are attached to via the USB cable. This virtual COM port provides an ideal connection for the <a class="el" href="qs.html">QS communication</a> with the <a class="el" href="qspy.html">QSPY host utility</a>.</p>
<div class="image">
<img src="platforms.png" alt=""/>
<div class="caption">
Targets for running QUTests. From the left: host computer, TivaC LaunchPad and EFM32 Pearl-Gecko</div></div>
<p>For example, to test the EFM32 Pearl-Gecko board (ARM Cortex-M4), open a command prompt (on Windows) and type:</p>
<pre class="fragment">qspy -c COM6
</pre><p>This will start the QSPY host utility with com-port connection to the embedded board. Of course, you need to adjust the serial port number to the actual number of the virtual COM port on your machine.</p>
<p>Next, open a <b>second</b> command prompt window and type:</p>
<pre class="fragment">cd C:\qp\qpc\examples\qutest\unity_basic\test
make -f make_efm32
</pre><p>The rest of the test is then exactly the same as with the host executable described <a class="el" href="qutest_unity.html#qutest_unity-run">above</a>, except that the <a class="el" href="qutest_unity.html#qutest_unity-fixture">test fixture</a> runs on the embedded board.</p>
<p>To run the tests on the TivaC LaunchPad (TM4C123 board), you use the <code>make_tm4c123</code> in the last step.</p>
<hr  />
<p><b>Next:</b> <a class="el" href="qutest_mock.html">Unity Mock Example</a></p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
    <div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
      <ul>
        <li class="footer">
<a title="Quantum Leaps: Modern Embedded Software" href="https://www.state-machine.com">&copy; 2005-2021 Quantum Leaps</a> &nbsp;| &nbsp; <a title="help" href="help.html">Using Online Help</a>&nbsp;| &nbsp;<a title="Doxygen" href="http://www.doxygen.nl">Generated with Doxygen</a>&nbsp; | &nbsp;<b>QTools 6.9.3</b>
<hr class="footer"/><address class="footer"><small>
<a title="Quantum Leaps: Modern Embedded Software" href="https://www.state-machine.com">&copy; Quantum Leaps 2020</a> &nbsp;| &nbsp; <a title="help" href="help.html">Using Online Help</a>&nbsp;| &nbsp;<a title="Doxygen" href="http://www.doxygen.nl">Generated with Doxygen</a>&nbsp; | &nbsp;<b>QTools 6.9.3</b>
</small></address>
        </li>
      </ul>
    </div>
    <script src="custom.js"></script>
  </body>
</html>
